<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Padre - Colegio CÃ©sar Vallejo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --institutional-yellow: #FFD700;
            --institutional-red: #DC143C;
            --institutional-white: #FFFFFF;
            --institutional-dark-red: #B71C1C;
            --institutional-light-yellow: #FFF9C4;
            --institutional-gold: #DAA520;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: var(--institutional-red);
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --shadow-color: rgba(220, 20, 60, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #FFD700 0%, #DC143C 50%, #000000 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
            padding-top: 70px;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(220, 20, 60, 0.1);
            border-bottom: 3px solid var(--institutional-yellow);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
            height: 70px;
        }

        .navbar-brand img {
            vertical-align: middle;
        }

        .navbar-brand span {
            vertical-align: middle;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg,
                rgba(220, 20, 60, 0.95) 0%,
                rgba(183, 28, 28, 0.95) 50%,
                rgba(255, 215, 0, 0.95) 100%);
            z-index: -1;
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--institutional-red) !important;
        }

        .navbar-brand i {
            color: var(--institutional-yellow);
            text-shadow: 2px 2px 4px rgba(220, 20, 60, 0.3);
        }

        .main-container {
            margin-top: 2rem;
            padding: 0 1rem;
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(220, 20, 60, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.4s ease;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(220, 20, 60, 0.15);
        }

        .card:hover::before {
            left: 100%;
        }

        .card-header {
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-dark-red));
            color: var(--institutional-white);
            border: none;
            border-radius: 20px 20px 0 0 !important;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: var(--institutional-yellow);
            opacity: 0.1;
            transform: rotate(45deg);
        }

        .card-header h4, .card-header h5 {
            position: relative;
            z-index: 1;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card-header p {
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            text-align: center;
            transition: all 0.4s ease;
            height: 100%;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--institutional-yellow), var(--institutional-red));
        }

        .stat-card:hover {
            transform: translateY(-15px) scale(1.02);
            box-shadow: 0 25px 50px rgba(220, 20, 60, 0.2);
            border-color: var(--institutional-yellow);
        }

        .stat-icon {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-dark-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-label {
            color: var(--institutional-red);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-dark-red));
            border: none;
            border-radius: 15px;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--institutional-yellow), transparent);
            opacity: 0.3;
            transition: left 0.6s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(220, 20, 60, 0.4);
            background: linear-gradient(135deg, var(--institutional-dark-red), var(--institutional-red));
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--institutional-yellow), var(--institutional-gold));
            border: none;
            border-radius: 15px;
            color: var(--institutional-red);
            font-weight: 600;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--institutional-white), var(--institutional-light-yellow));
            border: 2px solid var(--institutional-red);
            color: var(--institutional-red);
            border-radius: 15px;
            font-weight: 600;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--institutional-gold), var(--institutional-yellow));
            border: none;
            color: var(--institutional-red);
            border-radius: 15px;
            font-weight: 600;
        }

        .student-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(220, 20, 60, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid var(--institutional-yellow);
            position: relative;
            overflow: hidden;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--institutional-red), var(--institutional-yellow));
        }

        .student-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(220, 20, 60, 0.15);
            border-left-width: 8px;
        }

        .student-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-yellow));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.3);
            transition: all 0.3s ease;
        }

        .student-card:hover .student-avatar {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(220, 20, 60, 0.4);
        }

        .status-badge {
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-active {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }

        .status-pending {
            background: linear-gradient(135deg, var(--institutional-light-yellow), var(--institutional-yellow));
            color: var(--institutional-red);
            border: 2px solid var(--institutional-gold);
        }

        .status-approved {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        .status-rejected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: var(--institutional-red);
            border: 2px solid var(--institutional-red);
        }

        .payment-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border-left: 6px solid;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(220, 20, 60, 0.1);
            position: relative;
        }

        .payment-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--institutional-yellow), var(--institutional-gold));
            clip-path: polygon(100% 0, 0 0, 100% 100%);
            opacity: 0.3;
        }

        .payment-pending { border-left-color: var(--institutional-yellow); }
        .payment-overdue { border-left-color: var(--institutional-red); }
        .payment-paid { border-left-color: var(--success-color); }

        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(220, 20, 60, 0.15);
        }

        .fab-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-dark-red));
            border: none;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 15px 35px rgba(220, 20, 60, 0.4);
            transition: all 0.3s ease;
            z-index: 1040;
        }

        .fab-button:hover {
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 20px 45px rgba(220, 20, 60, 0.5);
            background: linear-gradient(135deg, var(--institutional-yellow), var(--institutional-gold));
            color: var(--institutional-red);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 4rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(220, 20, 60, 0.1);
        }

        .loading .spinner-border {
            width: 4rem;
            height: 4rem;
            color: var(--institutional-red);
            border-width: 0.4rem;
        }

        .loading p {
            color: var(--institutional-red);
            font-weight: 600;
            font-size: 1.2rem;
        }

        .dropdown-menu {
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(220, 20, 60, 0.15);
            border: 2px solid var(--institutional-yellow);
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--institutional-light-yellow), rgba(255, 215, 0, 0.2));
            color: var(--institutional-red);
        }

        .modal-content {
            border-radius: 20px;
            border: 3px solid var(--institutional-yellow);
            box-shadow: 0 25px 50px rgba(220, 20, 60, 0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-dark-red));
            border-radius: 17px 17px 0 0;
            border-bottom: 3px solid var(--institutional-yellow);
        }

        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--institutional-yellow);
            box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
        }

        .form-label {
            font-weight: 600;
            color: var(--institutional-red);
            margin-bottom: 0.8rem;
        }

        .toast {
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(220, 20, 60, 0.2);
            border: 2px solid var(--institutional-yellow);
        }

        .toast-header {
            background: linear-gradient(135deg, var(--institutional-light-yellow), rgba(255, 215, 0, 0.1));
            border-bottom: 1px solid var(--institutional-yellow);
        }

        .curso-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .curso-card:hover {
            border-color: var(--institutional-yellow);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.1);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .animate-slide-up {
            animation: slideInUp 0.6s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 0.5rem;
            }

            .card-header {
                padding: 1.5rem;
            }

            .stat-card {
                padding: 2rem 1.5rem;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .student-card, .payment-card {
                padding: 1.5rem;
            }

            .fab-button {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--institutional-red), var(--institutional-yellow));
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--institutional-dark-red), var(--institutional-gold));
        }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="https://imgur.com/Un4G2Du.png" alt="Logo Colegio CÃ©sar Vallejo" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
            <span style="font-size: 1.2rem; font-weight: 700; color: var(--institutional-red);">I.E 80351 CÃ©sar Vallejo</span>
        </a>
        <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
            <div class="nav-item dropdown me-3">
                <a class="nav-link dropdown-toggle position-relative" href="#" role="button" data-bs-toggle="dropdown">
                    <i class="fas fa-bell fs-5" style="color: var(--institutional-red);"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger animate-pulse" id="notificationCount">0</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" id="notificationDropdown">
                    <li><h6 class="dropdown-header">Notificaciones</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li id="noNotifications"><a class="dropdown-item text-muted" href="#">No hay notificaciones</a></li>
                </ul>
            </div>
            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--institutional-red), var(--institutional-yellow)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <span id="userName" style="color: var(--institutional-red); font-weight: 600;">Cargando...</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-user-edit me-2"></i>Mi Perfil</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>ConfiguraciÃ³n</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar SesiÃ³n</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid main-container">
    <div id="loading" class="loading">
        <div class="spinner-border" role="status"></div>
        <p class="mt-3">Cargando informaciÃ³n del dashboard...</p>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card animate__animated animate__fadeInDown">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-home me-2"></i>
                            Â¡Bienvenido, <span id="welcomeName"></span>!
                        </h4>
                        <p class="mb-0">Panel de control para padres de familia - Sistema de MatrÃ­culas</p>
                    </div>
                    <div class="card-body">
                        <div class="row" id="statsContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card animate__animated animate__fadeInUp animate-slide-up">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Acciones RÃ¡pidas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3 col-sm-6">
                                <button class="btn btn-primary w-100 py-3" onclick="abrirRegistroEstudiante()">
                                    <i class="fas fa-user-plus mb-2 d-block fs-3"></i>
                                    <strong>Registrar Estudiante</strong>
                                </button>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <button class="btn btn-success w-100 py-3" onclick="abrirNuevaMatricula()">
                                    <i class="fas fa-file-alt mb-2 d-block fs-3"></i>
                                    <strong>Nueva MatrÃ­cula</strong>
                                </button>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <button class="btn btn-info w-100 py-3" onclick="verPagos()">
                                    <i class="fas fa-credit-card mb-2 d-block fs-3"></i>
                                    <strong>Ver Pagos</strong>
                                </button>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <button class="btn btn-warning w-100 py-3" onclick="verHorarios()">
                                    <i class="fas fa-calendar-alt mb-2 d-block fs-3"></i>
                                    <strong>Horarios de clase</strong>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card animate__animated animate__fadeInLeft">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Mis Estudiantes</h5>
                        <button class="btn btn-sm" style="background: rgba(255, 255, 255, 0.2); color: white; border-radius: 10px;" onclick="refrescarEstudiantes()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="estudiantesContainer"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card animate__animated animate__fadeInRight">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Pagos Pendientes</h5>
                        <span class="badge rounded-pill animate-pulse" style="background: var(--institutional-yellow); color: var(--institutional-red); font-weight: 700;" id="pagosPendientesCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="pagosPendientesContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card animate__animated animate__fadeInUp">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Actividad Reciente</h5>
                    </div>
                    <div class="card-body">
                        <div id="actividadRecienteContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<button class="fab-button" onclick="abrirNuevaMatricula()" title="Nueva MatrÃ­cula">
    <i class="fas fa-plus"></i>
</button>

<!-- Modal Registro Estudiante -->
<div class="modal fade" id="registroEstudianteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white"><i class="fas fa-user-plus me-2"></i>Registrar Nuevo Estudiante</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registroEstudianteForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombres" class="form-label">Nombres *</label>
                            <input type="text" class="form-control" id="nombres" name="nombres" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellidos" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="apellidos" name="apellidos" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoDocumento" class="form-label">Tipo de Documento *</label>
                            <select class="form-select" id="tipoDocumento" name="tipoDocumento" required>
                                <option value="">Seleccionar...</option>
                                <option value="DNI">DNI</option>
                                <option value="CE">Carnet de ExtranjerÃ­a</option>
                                <option value="PASAPORTE">Pasaporte</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="numeroDocumento" class="form-label">NÃºmero de Documento *</label>
                            <input type="text" class="form-control" id="numeroDocumento" name="numeroDocumento" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento *</label>
                            <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="genero" class="form-label">GÃ©nero *</label>
                            <select class="form-select" id="genero" name="genero" required>
                                <option value="">Seleccionar...</option>
                                <option value="MASCULINO">Masculino</option>
                                <option value="FEMENINO">Femenino</option>
                                <option value="OTRO">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">DirecciÃ³n</label>
                        <input type="text" class="form-control" id="direccion" name="direccion">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label">TelÃ©fono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombreContactoEmergencia" class="form-label">Contacto de Emergencia</label>
                            <input type="text" class="form-control" id="nombreContactoEmergencia" name="nombreContactoEmergencia">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="telefonoEmergencia" class="form-label">TelÃ©fono de Emergencia</label>
                            <input type="tel" class="form-control" id="telefonoEmergencia" name="telefonoEmergencia">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="alergias" class="form-label">Alergias</label>
                        <textarea class="form-control" id="alergias" name="alergias" rows="2" placeholder="Especificar alergias conocidas..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="condicionesMedicas" class="form-label">Condiciones MÃ©dicas</label>
                        <textarea class="form-control" id="condicionesMedicas" name="condicionesMedicas" rows="2" placeholder="Especificar condiciones mÃ©dicas relevantes..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="tipoSangre" class="form-label">Tipo de Sangre</label>
                        <select class="form-select" id="tipoSangre" name="tipoSangre">
                            <option value="">Seleccionar...</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarEstudiante()">
                    <i class="fas fa-save me-2"></i>Registrar Estudiante
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva MatrÃ­cula -->
<div class="modal fade" id="nuevaMatriculaModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white"><i class="fas fa-file-alt me-2"></i>Nueva MatrÃ­cula</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="nuevaMatriculaStep1">
                    <h6 class="mb-4" style="color: var(--institutional-red); font-weight: 700;">
                        <i class="fas fa-user-check me-2"></i>Paso 1: Seleccionar Estudiante
                    </h6>
                    <div class="row" id="estudiantesSeleccion"></div>
                    <div class="text-end mt-4">
                        <button class="btn btn-primary" onclick="siguientePasoMatricula()" disabled id="btnSiguienteEstudiante">
                            <i class="fas fa-arrow-right me-2"></i>Siguiente
                        </button>
                    </div>
                </div>

                <div id="nuevaMatriculaStep2" style="display: none;">
                    <h6 class="mb-4" style="color: var(--institutional-red); font-weight: 700;">
                        <i class="fas fa-book me-2"></i>Paso 2: Seleccionar Cursos
                    </h6>
                    <div id="errorCursos" class="alert alert-danger" style="display: none;"></div>
                    <form id="matriculaForm">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="nivelAcademico" class="form-label">Nivel AcadÃ©mico *</label>
                                <select class="form-select" id="nivelAcademico" name="nivelAcademico" required onchange="cargarCursosPorNivel()">
                                    <option value="">Seleccionar...</option>
                                    <option value="INICIAL">Inicial</option>
                                    <option value="PRIMARIA">Primaria</option>
                                    <option value="SECUNDARIA">Secundaria</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="anioAcademico" class="form-label">AÃ±o AcadÃ©mico *</label>
                                <input type="text" id="anioAcademico" name="anioAcademico" class="form-control" placeholder="2025" required>
                            </div>
                            <div class="col-md-4">
                                <label for="grado" class="form-label">Grado *</label>
                                <select class="form-select" id="grado" name="grado" required onchange="cargarCursosPorGrado()">
                                    <option value="">Seleccionar nivel primero</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="seccion" class="form-label">SecciÃ³n</label>
                                <select class="form-select" id="seccion" name="seccion">
                                    <option value="">Seleccionar...</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Cursos Disponibles</label>
                            <div id="cursosDisponibles" class="row"></div>
                        </div>
                        <div class="mb-4">
                            <label for="comentariosApoderado" class="form-label">Comentarios Adicionales</label>
                            <textarea class="form-control" id="comentariosApoderado" name="comentariosApoderado" rows="3" placeholder="Comentarios o solicitudes especiales..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card" style="background: var(--institutional-light-yellow); border: 2px solid var(--institutional-yellow);">
                                    <div class="card-body">
                                        <h6 style="color: var(--institutional-red);">
                                            <i class="fas fa-calculator me-2"></i>Resumen de Costos
                                        </h6>
                                        <div id="resumenCostos">
                                            <p class="mb-1">MatrÃ­cula: <span class="float-end">S/ 0.00</span></p>
                                            <p class="mb-1">Mensualidad: <span class="float-end">S/ 0.00</span></p>
                                            <p class="mb-1">Materiales: <span class="float-end">S/ 0.00</span></p>
                                            <hr style="border-color: var(--institutional-red);">
                                            <h6 style="color: var(--institutional-red);">Total: <span class="float-end">S/ 0.00</span></h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card" style="background: rgba(220, 20, 60, 0.1); border: 2px solid var(--institutional-red);">
                                    <div class="card-body">
                                        <h6 style="color: var(--institutional-red);">
                                            <i class="fas fa-info-circle me-2"></i>InformaciÃ³n Importante
                                        </h6>
                                        <ul class="mb-0" style="color: var(--institutional-red); font-size: 0.9rem;">
                                            <li>La matrÃ­cula tiene 30 dÃ­as de vigencia</li>
                                            <li>Los pagos se generan automÃ¡ticamente</li>
                                            <li>La aprobaciÃ³n puede tomar 1-2 dÃ­as hÃ¡biles</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="text-end mt-4">
                        <button class="btn btn-secondary me-2" onclick="anteriorPasoMatricula()">
                            <i class="fas fa-arrow-left me-2"></i>Anterior
                        </button>
                        <button class="btn btn-success" onclick="enviarMatricula()" id="btnEnviarMatricula">
                            <i class="fas fa-paper-plane me-2"></i>Enviar MatrÃ­cula
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast de Notificaciones -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;">
    <div id="notificationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-bell me-2" style="color: var(--institutional-red);"></i>
            <strong class="me-auto" style="color: var(--institutional-red);">CÃ©sar Vallejo</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    const API_BASE_URL = `${window.location.origin}/api`;
  let currentUser = null;
  let stompClient = null;
  let dashboardData = null;
  let selectedStudent = null;
  let selectedCourses = [];
  let availableCourses = [];

  document.addEventListener('DOMContentLoaded', function() {
      verificarAutenticacion();
  });

  function verificarAutenticacion() {
      const token = localStorage.getItem('token');
      const usuario = localStorage.getItem('usuario');

      if (!token || !usuario) {
          window.location.href = 'login.html';
          return;
      }

      try {
          currentUser = JSON.parse(usuario);

          if (currentUser.rol !== 'PADRE') {
              if (currentUser.rol === 'ADMIN') {
                  window.location.href = 'admin-dashboard.html';
                  return;
              } else {
                  cerrarSesion();
                  return;
              }
          }

          document.getElementById('userName').textContent = currentUser.nombre;
          document.getElementById('welcomeName').textContent = currentUser.nombre;

          cargarDashboard();
          conectarWebSocket();
      } catch (error) {
          console.error('Error al verificar autenticaciÃ³n:', error);
          cerrarSesion();
      }
  }

  async function cargarDashboard() {
      try {
          document.getElementById('loading').style.display = 'block';
          document.getElementById('dashboardContent').style.display = 'none';

          const token = localStorage.getItem('token');
          if (!token) {
              mostrarError('No se encontrÃ³ un token de acceso. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
              cerrarSesion();
              return;
          }

          const response = await fetch(`${API_BASE_URL}/dashboard/padre/${currentUser.id}`, {
              headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
              }
          });

          if (!response.ok) {
              if (response.status === 401) {
                  mostrarError('SesiÃ³n expirada. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
                  cerrarSesion();
                  return;
              }
              throw new Error(`Error al cargar dashboard: ${response.status}`);
          }

          dashboardData = await response.json();
          console.log('Datos del dashboard:', dashboardData);
          mostrarDashboard();
      } catch (error) {
          console.error('Error:', error);
          mostrarError(`Error al cargar la informaciÃ³n del dashboard: ${error.message}`, 'toast');
      } finally {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboardContent').style.display = 'block';
      }
  }

  function mostrarDashboard() {
      mostrarEstadisticas();
      mostrarEstudiantes();
      mostrarPagosPendientes();
      mostrarActividadReciente();
  }

  function mostrarEstadisticas() {
      const statsContainer = document.getElementById('statsContainer');
      const stats = [
          {
              icon: 'fas fa-users',
              number: dashboardData.totalEstudiantes || 0,
              label: 'Estudiantes'
          },
          {
              icon: 'fas fa-file-alt',
              number: dashboardData.matriculasActivas || 0,
              label: 'MatrÃ­culas Activas'
          },
          {
              icon: 'fas fa-clock',
              number: dashboardData.matriculasPendientes || 0,
              label: 'Pendientes'
          },
          {
              icon: 'fas fa-dollar-sign',
              number: `S/ ${(dashboardData.totalDeuda || 0).toFixed(2)}`,
              label: 'Deuda Total'
          }
      ];

      statsContainer.innerHTML = stats.map(stat => `
          <div class="col-md-3 col-sm-6 mb-3">
              <div class="stat-card">
                  <div class="stat-icon">
                      <i class="${stat.icon}"></i>
                  </div>
                  <div class="stat-number">${stat.number}</div>
                  <div class="stat-label">${stat.label}</div>
              </div>
          </div>
      `).join('');
  }

  function mostrarEstudiantes() {
      const container = document.getElementById('estudiantesContainer');
      const estudiantes = dashboardData.estudiantes || [];

      if (estudiantes.length === 0) {
          container.innerHTML = `
              <div class="text-center py-5">
                  <i class="fas fa-user-plus fa-4x mb-4" style="color: var(--institutional-yellow); opacity: 0.7;"></i>
                  <h4 style="color: var(--institutional-red);">No hay estudiantes registrados</h4>
                  <p style="color: var(--institutional-red); opacity: 0.8;">Comienza registrando tu primer estudiante para iniciar el proceso de matrÃ­cula</p>
                  <button class="btn btn-primary btn-lg mt-3" onclick="abrirRegistroEstudiante()">
                      <i class="fas fa-plus me-2"></i>Registrar Primer Estudiante
                  </button>
              </div>
          `;
          return;
      }

      container.innerHTML = estudiantes.map(estudiante => `
          <div class="student-card animate-slide-up">
              <div class="d-flex align-items-center">
                  <div class="student-avatar">
                      ${estudiante.nombreCompleto.charAt(0).toUpperCase()}
                  </div>
                  <div class="ms-4 flex-grow-1">
                      <h5 class="mb-2" style="color: var(--institutional-red); font-weight: 700;">${estudiante.nombreCompleto}</h5>
                      <p class="mb-2" style="color: var(--institutional-red); opacity: 0.8;">
                          <i class="fas fa-graduation-cap me-2"></i>
                          ${estudiante.grado || 'Sin asignar'} ${estudiante.seccion ? `- SecciÃ³n ${estudiante.seccion}` : ''}
                      </p>
                      <div class="d-flex align-items-center flex-wrap gap-2">
                          <span class="status-badge status-${getStatusClass(estudiante.estado)}">
                              ${getStatusText(estudiante.estado)}
                          </span>

                      </div>
                  </div>
                  <div class="dropdown">
                      <button class="btn btn-outline-danger dropdown-toggle" type="button" data-bs-toggle="dropdown" style="border-color: var(--institutional-red); color: var(--institutional-red);">
                          <i class="fas fa-cog"></i>
                      </button>
                      <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" onclick="verDetalleEstudiante(${estudiante.id})">
                              <i class="fas fa-eye me-2"></i>Ver Detalles
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="nuevaMatriculaEstudiante(${estudiante.id})">
                              <i class="fas fa-file-alt me-2"></i>Nueva MatrÃ­cula
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="verCalificacionesEstudiante(${estudiante.id})">
                              <i class="fas fa-chart-bar me-2"></i>Calificaciones
                          </a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="#" onclick="editarEstudiante(${estudiante.id})">
                              <i class="fas fa-edit me-2"></i>Editar
                          </a></li>
                      </ul>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function mostrarPagosPendientes() {
      const container = document.getElementById('pagosPendientesContainer');
      const countBadge = document.getElementById('pagosPendientesCount');

      const pagosPendientes = (dashboardData.proximosVencimientos || []).filter(pago =>
          pago.estado === 'PENDIENTE' || pago.estado === 'PARCIAL'
      );

      countBadge.textContent = pagosPendientes.length;

      if (pagosPendientes.length === 0) {
          container.innerHTML = `
              <div class="text-center py-4">
                  <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                  <h6 class="text-success">Â¡No hay pagos pendientes!</h6>
                  <p class="text-muted mb-0">Todas las cuentas estÃ¡n al dÃ­a</p>
              </div>
          `;
          return;
      }

      container.innerHTML = pagosPendientes.map(pago => `
          <div class="payment-card payment-${getPagoStatusClass(pago.estado, pago.diasParaVencimiento)}">
              <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-1" style="color: var(--institutional-red); font-weight: 600;">${pago.concepto}</h6>
                  <strong class="fs-5" style="color: ${pago.diasParaVencimiento < 0 ? 'var(--institutional-red)' : 'var(--institutional-gold)'}">
                      S/ ${pago.monto.toFixed(2)}
                  </strong>
              </div>
              <small style="color: ${pago.diasParaVencimiento < 0 ? 'var(--institutional-red)' : 'var(--institutional-gold)'}; font-weight: 600;">
                  ${pago.diasParaVencimiento < 0 ?
                      `â ï¸ Vencido hace ${Math.abs(pago.diasParaVencimiento)} dÃ­as` :
                      pago.diasParaVencimiento === 0 ? 'ð Vence hoy' :
                      `ð Vence en ${pago.diasParaVencimiento} dÃ­as`
                  }
              </small>
          </div>
      `).join('');
  }

  function mostrarActividadReciente() {
      const container = document.getElementById('actividadRecienteContainer');
      const actividades = [
          {
              icon: 'fas fa-file-alt',
              color: 'var(--institutional-yellow)',
              titulo: 'MatrÃ­cula en proceso',
              descripcion: 'MatrÃ­cula enviada para revisiÃ³n administrativa',
              fecha: 'Hace 2 horas'
          },
          {
              icon: 'fas fa-credit-card',
              color: 'var(--institutional-red)',
              titulo: 'Pago registrado',
              descripcion: 'Pago de mensualidad procesado exitosamente',
              fecha: 'Ayer'
          },
          {
              icon: 'fas fa-bell',
              color: 'var(--institutional-gold)',
              titulo: 'Recordatorio importante',
              descripcion: 'PrÃ³ximo vencimiento de pago en 5 dÃ­as',
              fecha: 'Hace 3 dÃ­as'
          }
      ];

      container.innerHTML = actividades.map(actividad => `
          <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
              <div class="me-4" style="width: 50px; height: 50px; border-radius: 50%; background: ${actividad.color}; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(220, 20, 60, 0.2);">
                  <i class="${actividad.icon} text-white"></i>
              </div>
              <div class="flex-grow-1">
                  <h6 class="mb-1" style="color: var(--institutional-red); font-weight: 600;">${actividad.titulo}</h6>
                  <p class="mb-0" style="color: var(--institutional-red); opacity: 0.8;">${actividad.descripcion}</p>
              </div>
              <div style="color: var(--institutional-red); opacity: 0.6;">
                  <small>${actividad.fecha}</small>
              </div>
          </div>
      `).join('');
  }

  function getStatusClass(estado) {
      const statusMap = {
          'ACTIVO': 'active',
          'PENDIENTE': 'pending',
          'APROBADA': 'approved',
          'RECHAZADA': 'rejected'
      };
      return statusMap[estado] || 'active';
  }

  function getStatusText(estado) {
      const textMap = {
          'ACTIVO': 'Activo',
          'PENDIENTE': 'Pendiente',
          'APROBADA': 'Aprobada',
          'RECHAZADA': 'Rechazada'
      };
      return textMap[estado] || estado;
  }

  function getPagoStatusClass(estado, diasVencimiento) {
      if (diasVencimiento < 0) return 'overdue';
      if (estado === 'PAGADO') return 'paid';
      return 'pending';
  }

  function conectarWebSocket() {
      const token = localStorage.getItem('token');
      const socket = new SockJS(`${API_BASE_URL}/ws?token=${token}`);
      stompClient = Stomp.over(socket);

      stompClient.connect({}, () => {
          console.log('â WebSocket conectado correctamente');

          stompClient.subscribe(`/user/${currentUser.id}/queue/notificaciones`, (message) => {
              const notificacion = JSON.parse(message.body);
              console.log('ð NotificaciÃ³n recibida:', notificacion);

              mostrarNotificacion(notificacion);

              if (notificacion.titulo && notificacion.titulo.includes('MatrÃ­cula Aprobada')) {
                  setTimeout(cargarDashboard, 2000);
              }
          });
      }, (error) => {
          console.error('â Error de WebSocket:', error);
      });
  }

  function mostrarNotificacion(notificacion) {
      const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
      document.getElementById('toastMessage').textContent = notificacion.mensaje || notificacion.message || 'Nueva notificaciÃ³n';
      toast.show();
      actualizarConteoNotificaciones();
  }

  function actualizarConteoNotificaciones() {
      const notificationCount = document.getElementById('notificationCount');
      const currentCount = parseInt(notificationCount.textContent) || 0;
      notificationCount.textContent = currentCount + 1;
      document.getElementById('noNotifications').style.display = 'none';
  }

  function mostrarError(mensaje, target = 'toast') {
      if (target === 'toast') {
          const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
          document.getElementById('toastMessage').textContent = mensaje;
          toast.show();
      } else if (target === 'cursos') {
          const errorContainer = document.getElementById('errorCursos');
          if (errorContainer) {
              errorContainer.textContent = mensaje;
              errorContainer.style.display = 'block';
              setTimeout(() => errorContainer.style.display = 'none', 5000);
          }
      }
  }

  function cerrarSesion() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.location.href = 'login.html';
  }

  function abrirRegistroEstudiante() {
      document.getElementById('registroEstudianteForm').reset();
      const modal = new bootstrap.Modal(document.getElementById('registroEstudianteModal'));
      modal.show();
  }

  async function guardarEstudiante() {
      const form = document.getElementById('registroEstudianteForm');
      if (!form.checkValidity()) {
          form.reportValidity();
          return;
      }

      const estudianteData = {
          nombres: document.getElementById('nombres').value,
          apellidos: document.getElementById('apellidos').value,
          tipoDocumento: document.getElementById('tipoDocumento').value,
          numeroDocumento: document.getElementById('numeroDocumento').value,
          fechaNacimiento: document.getElementById('fechaNacimiento').value,
          genero: document.getElementById('genero').value,
          direccion: document.getElementById('direccion').value,
          telefono: document.getElementById('telefono').value,
          email: document.getElementById('email').value,
          nombreContactoEmergencia: document.getElementById('nombreContactoEmergencia').value,
          telefonoEmergencia: document.getElementById('telefonoEmergencia').value,
          alergias: document.getElementById('alergias').value,
          condicionesMedicas: document.getElementById('condicionesMedicas').value,
          tipoSangre: document.getElementById('tipoSangre').value,
          apoderadoId: currentUser.id
      };

      try {
          const token = localStorage.getItem('token');
          if (!token) {
              mostrarError('No se encontrÃ³ un token de acceso. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
              cerrarSesion();
              return;
          }

          const response = await fetch(`${API_BASE_URL}/estudiantes`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(estudianteData)
          });

          if (!response.ok) {
              if (response.status === 401) {
                  mostrarError('SesiÃ³n expirada. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
                  cerrarSesion();
                  return;
              }
              const errorData = await response.json();
              throw new Error(`Error al registrar estudiante: ${errorData.message || 'Datos invÃ¡lidos'}`);
          }

          bootstrap.Modal.getInstance(document.getElementById('registroEstudianteModal')).hide();
          mostrarNotificacion({ mensaje: 'Estudiante registrado con Ã©xito' });
          cargarDashboard();
      } catch (error) {
          console.error('Error:', error);
          mostrarError(`Error al registrar estudiante: ${error.message}`, 'toast');
      }
  }

  function abrirNuevaMatricula() {
      if (!dashboardData.estudiantes || dashboardData.estudiantes.length === 0) {
          mostrarError('Primero debe registrar al menos un estudiante para poder crear una matrÃ­cula', 'toast');
          return;
      }
      resetearModalMatricula();
      cargarEstudiantesParaMatricula();
      const modal = new bootstrap.Modal(document.getElementById('nuevaMatriculaModal'));
      modal.show();
  }

  function resetearModalMatricula() {
      document.getElementById('nuevaMatriculaStep1').style.display = 'block';
      document.getElementById('nuevaMatriculaStep2').style.display = 'none';
      selectedStudent = null;
      selectedCourses = [];
      document.getElementById('btnSiguienteEstudiante').disabled = true;
      document.getElementById('matriculaForm').reset();
      document.getElementById('cursosDisponibles').innerHTML = '';
      document.getElementById('errorCursos').style.display = 'none';
  }

  function cargarEstudiantesParaMatricula() {
      const container = document.getElementById('estudiantesSeleccion');
      const estudiantes = dashboardData.estudiantes || [];
      container.innerHTML = estudiantes.map(estudiante => `
          <div class="col-md-6 mb-3">
              <div class="card h-100" style="cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease;" onclick="seleccionarEstudiante(${estudiante.id}, '${estudiante.nombreCompleto}', this)">
                  <div class="card-body text-center">
                      <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--institutional-red), var(--institutional-yellow)); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                          <span class="text-white fw-bold fs-4">${estudiante.nombreCompleto.charAt(0)}</span>
                      </div>
                      <h6 style="color: var(--institutional-red);">${estudiante.nombreCompleto}</h6>
                      <p class="mb-0" style="color: var(--institutional-red); opacity: 0.8;">${estudiante.grado || 'Sin asignar'}</p>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function seleccionarEstudiante(id, nombre, element) {
      selectedStudent = { id, nombre };
      document.querySelectorAll('#estudiantesSeleccion .card').forEach(card => {
          card.style.border = '2px solid transparent';
      });
      element.style.border = '2px solid var(--institutional-yellow)';
      document.getElementById('btnSiguienteEstudiante').disabled = false;
  }

  function siguientePasoMatricula() {
      if (!selectedStudent) {
          mostrarError('Por favor, seleccione un estudiante', 'toast');
          return;
      }
      document.getElementById('nuevaMatriculaStep1').style.display = 'none';
      document.getElementById('nuevaMatriculaStep2').style.display = 'block';
  }

  function anteriorPasoMatricula() {
      document.getElementById('nuevaMatriculaStep2').style.display = 'none';
      document.getElementById('nuevaMatriculaStep1').style.display = 'block';
  }

  async function cargarCursosPorNivel() {
      let nivel = document.getElementById('nivelAcademico').value?.trim();
      if (!nivel) {
          mostrarError('Por favor, seleccione un nivel acadÃ©mico', 'cursos');
          return;
      }

      try {
          const token = localStorage.getItem('token');
          if (!token) {
              mostrarError('No se encontrÃ³ un token de acceso. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
              cerrarSesion();
              return;
          }

          const cleanUrl = `${API_BASE_URL}/cursos/disponibles?nivel=${encodeURIComponent(nivel.toUpperCase())}`;
          console.log('URL generada:', cleanUrl);

          const response = await fetch(cleanUrl, {
              headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
              }
          });

          if (!response.ok) {
              if (response.status === 401) {
                  mostrarError('SesiÃ³n expirada. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
                  cerrarSesion();
                  return;
              }
              let errorMessage = 'Error desconocido';
              try {
                  const errorData = await response.json();
                  errorMessage = errorData.message || 'No message available';
              } catch (e) {
                  errorMessage = 'Respuesta del servidor no vÃ¡lida';
              }
              throw new Error(`Error al cargar cursos: ${response.status} - ${errorMessage}`);
          }

          const cursos = await response.json();
          availableCourses = cursos;
          console.log('Cursos cargados:', cursos);

          const gradosUnicos = [...new Set((cursos || []).map(c => c.grado))];
          const gradoSelect = document.getElementById('grado');
          if (gradoSelect) {
              gradoSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                  gradosUnicos.map(grado => `<option value="${grado}">${grado}</option>`).join('');
          }

          document.getElementById('cursosDisponibles').innerHTML = '';
          selectedCourses = [];
          actualizarResumenCostos();

      } catch (error) {
          console.error('Error:', error);
          mostrarError(`Error al cargar los cursos: ${error.message}`, 'cursos');
      }
  }

  async function cargarCursosPorGrado() {
      const nivel = document.getElementById('nivelAcademico').value?.trim();
      const grado = document.getElementById('grado').value?.trim();
      const container = document.getElementById('cursosDisponibles');

      if (!nivel || !grado || !container) {
          console.warn("Faltan datos para cargar cursos por grado");
          return;
      }

      const url = `${API_BASE_URL}/cursos/nivel/${encodeURIComponent(nivel.toUpperCase())}/grado/${encodeURIComponent(grado)}`;
      console.log("URL generada:", url);

      try {
          const response = await fetch(url, {
              headers: {
                  "Authorization": "Bearer " + localStorage.getItem("token"),
                  "Content-Type": "application/json"
              }
          });

          if (!response.ok) {
              throw new Error("Error al cargar cursos");
          }

          const cursos = await response.json();
          console.log('Cursos por grado:', cursos);
          container.innerHTML = "";

          if (!cursos || cursos.length === 0) {
              container.innerHTML = `
                  <div class="col-12 text-center p-3 text-muted">
                      <i class="fas fa-book fa-2x mb-2"></i>
                      <p>No hay cursos disponibles para este grado.</p>
                  </div>
              `;
              return;
          }

          cursos.forEach(curso => {
              const cursoCard = document.createElement("div");
              cursoCard.classList.add("col-md-6", "mb-3");

              cursoCard.innerHTML = `
                  <div class="curso-card shadow-sm p-3 rounded">
                      <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="curso-${curso.id}" value="${curso.id}"
                              onchange="actualizarCursosSeleccionados(this)"
                              data-nombre="${curso.nombre}"
                              data-profesor="${curso.nombreProfesor || 'Sin asignar'}"
                              data-modalidad="${curso.modalidad}"
                              data-horario="${curso.horarioCompleto || 'Sin horario'}"
                              data-aula="${curso.aula || 'Sin aula'}"
                              data-matricula="${curso.costoMatricula || 0}"
                              data-mensualidad="${curso.costoMensualidad || 0}"
                              data-materiales="${curso.costoMateriales || 0}"
                          >
                          <label class="form-check-label fw-bold w-100" for="curso-${curso.id}">
                              <div class="d-flex justify-content-between align-items-start">
                                  <div>
                                      <div>${curso.nombre || "Sin nombre"}</div>
                                      <small class="text-muted">${curso.creditos || 0} crÃ©ditos - ${curso.nombreProfesor || 'Sin profesor'}</small>
                                      <div><small class="text-muted"><i class="fas fa-clock me-1"></i>${curso.horarioCompleto || 'Sin horario'}</small></div>
                                      <div><small class="text-muted"><i class="fas fa-door-open me-1"></i>Aula ${curso.aula || 'N/A'}</small></div>
                                  </div>
                                  <div class="text-end">
                                      <small class="text-primary fw-bold">S/ ${(parseFloat(curso.costoMatricula || 0) + parseFloat(curso.costoMensualidad || 0) + parseFloat(curso.costoMateriales || 0)).toFixed(2)}</small>
                                  </div>
                              </div>
                          </label>
                      </div>
                  </div>
              `;

              container.appendChild(cursoCard);
          });

      } catch (error) {
          console.error("Error cargando cursos:", error);
          container.innerHTML = `
              <div class="col-12 alert alert-danger text-center">
                  <i class="fas fa-exclamation-circle"></i> Error al cargar cursos
              </div>
          `;
      }
  }

  function actualizarCursosSeleccionados(checkbox) {
      const cursoId = parseInt(checkbox.value);
      if (checkbox.checked) {
          if (!selectedCourses.includes(cursoId)) selectedCourses.push(cursoId);
      } else {
          selectedCourses = selectedCourses.filter(id => id !== cursoId);
      }
      console.log('Cursos seleccionados:', selectedCourses);
      actualizarResumenCostos();
  }

  function actualizarResumenCostos() {
      let totalMatricula = 0;
      let totalMensualidad = 0;
      let totalMateriales = 0;

      selectedCourses.forEach(id => {
          const checkbox = document.getElementById(`curso-${id}`);
          if (checkbox) {
              totalMatricula += parseFloat(checkbox.dataset.matricula) || 0;
              totalMensualidad += parseFloat(checkbox.dataset.mensualidad) || 0;
              totalMateriales += parseFloat(checkbox.dataset.materiales) || 0;
          }
      });

      const total = totalMatricula + totalMensualidad + totalMateriales;

      document.getElementById('resumenCostos').innerHTML = `
          <p class="mb-1">MatrÃ­cula: <span class="float-end">S/ ${totalMatricula.toFixed(2)}</span></p>
          <p class="mb-1">Mensualidad: <span class="float-end">S/ ${totalMensualidad.toFixed(2)}</span></p>
          <p class="mb-1">Materiales: <span class="float-end">S/ ${totalMateriales.toFixed(2)}</span></p>
          <hr style="border-color: var(--institutional-red);">
          <h6 style="color: var(--institutional-red);">Total: <span class="float-end">S/ ${total.toFixed(2)}</span></h6>
      `;
  }

  async function enviarMatricula() {
      const form = document.getElementById('matriculaForm');
      if (!form.checkValidity()) {
          form.reportValidity();
          return;
      }

      if (!selectedStudent || selectedCourses.length === 0) {
          mostrarError('Por favor, seleccione un estudiante y al menos un curso', 'cursos');
          return;
      }

      const anioAcademicoElement = document.getElementById('anioAcademico');
      const anioAcademicoValue = anioAcademicoElement ? anioAcademicoElement.value.trim() : null;

      if (!anioAcademicoValue) {
          mostrarError('El aÃ±o acadÃ©mico es obligatorio', 'toast');
          return;
      }

      const btnEnviar = document.getElementById('btnEnviarMatricula');
      const textoOriginal = btnEnviar.innerHTML;
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';

      try {
          const matriculaData = {
              estudianteId: selectedStudent.id,
              nivelAcademico: document.getElementById('nivelAcademico').value.toUpperCase(),
              grado: document.getElementById('grado').value,
              seccion: document.getElementById('seccion').value || null,
              anioAcademico: anioAcademicoValue,
              cursosIds: selectedCourses,
              comentariosApoderado: document.getElementById('comentariosApoderado').value || null
          };

          console.log('Datos de matrÃ­cula a enviar:', matriculaData);

          const token = localStorage.getItem('token');
          if (!token) {
              mostrarError('No se encontrÃ³ un token de acceso. Por favor, inicia sesiÃ³n nuevamente.', 'toast');
              cerrarSesion();
              return;
          }

          const matriculaResponse = await fetch(`${API_BASE_URL}/matriculas`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json; charset=utf-8'
              },
              body: JSON.stringify(matriculaData)
          });

          if (!matriculaResponse.ok) {
              const errorData = await matriculaResponse.json().catch(() => ({}));
              throw new Error(errorData.mensaje || errorData.message || 'Error al crear la matrÃ­cula');
          }

          const matriculaCreada = await matriculaResponse.json();
          console.log('MatrÃ­cula creada:', matriculaCreada);

          bootstrap.Modal.getInstance(document.getElementById('nuevaMatriculaModal')).hide();
          mostrarNotificacion({ mensaje: 'MatrÃ­cula enviada exitosamente. Los costos serÃ¡n calculados por el administrador.' });

          setTimeout(() => {
              cargarDashboard();
          }, 1000);

      } catch (error) {
          console.error('Error al crear matrÃ­cula:', error);
          mostrarError(`Error al crear la matrÃ­cula: ${error.message}`, 'toast');
      } finally {
          btnEnviar.disabled = false;
          btnEnviar.innerHTML = textoOriginal;
      }
  }

  function verPagos() {
      window.location.href = 'pagos.html';
  }

  function verHorarios() {
      window.location.href = 'horarios.html';
  }

  function refrescarEstudiantes() {
      cargarDashboard();
  }

  function verDetalleEstudiante(id) {
      window.location.href = `detalle-estudiante.html?id=${id}`;
  }

  function nuevaMatriculaEstudiante(id) {
      const estudiante = dashboardData.estudiantes.find(e => e.id === id);
      if (estudiante) {
          selectedStudent = { id, nombre: estudiante.nombreCompleto };
          document.getElementById('nuevaMatriculaStep1').style.display = 'none';
          document.getElementById('nuevaMatriculaStep2').style.display = 'block';
          const modal = new bootstrap.Modal(document.getElementById('nuevaMatriculaModal'));
          modal.show();
      }
  }

  function verCalificacionesEstudiante(id) {
      window.location.href = `calificaciones.html?estudianteId=${id}`;
  }

  function editarEstudiante(id) {
      window.location.href = `editar-estudiante.html?id=${id}`;
  }

  setInterval(() => {
      cargarDashboard();
  }, 30000);
</script>
</body>
</html>